___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Firestore Writer",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Waster",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Use this tag for writing data to the Firestore.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "collection",
    "displayName": "Firebase Collection",
    "simpleValueType": true,
    "help": "The path to the collection. If the path is to a collection, a document will be created with a randomly generated ID.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "documentId",
    "displayName": "Firebase Document",
    "simpleValueType": true,
    "help": "The path to the document. Must not start or end with a \u0027/\u0027.  If the path is to a collection, a document will be created with a randomly generated ID."
  },
  {
    "type": "CHECKBOX",
    "name": "addEventData",
    "checkboxText": "Add Event Data",
    "simpleValueType": true,
    "help": "Add all Event Data to the document. If Event Data and Custom Data have the same field, the Custom Data value will be used for that field. In other words, you can override Event Data values with Custom Data."
  },
  {
    "type": "CHECKBOX",
    "name": "firebaseMerge",
    "checkboxText": "Merge document keys",
    "simpleValueType": true,
    "help": "If checked then merge the keys from the input into the document, otherwise the method will override the whole document."
  },
  {
    "type": "CHECKBOX",
    "name": "addTimestamp",
    "checkboxText": "Add Timestamp",
    "simpleValueType": true,
    "help": "This option will add the millisecond timestamp to the document."
  },
  {
    "type": "CHECKBOX",
    "name": "skipNilValues",
    "checkboxText": "Skip null or undefined values",
    "simpleValueType": true,
    "help": "This option allows skipping items from customDataList with undefined or null values."
  },
  {
    "displayName": "Custom Data",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Field Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Field Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const Firestore = require('Firestore');
const getRequestHeader = require('getRequestHeader');
const getAllEventData = require('getAllEventData');
const getTimestampMillis = require('getTimestampMillis');
const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const getType = require('getType');
const containerVersion = getContainerVersion();
const isDebug = containerVersion.debugMode;
const isLoggingEnabled = determinateIsLoggingEnabled();

let input = data.addEventData ? getAllEventData() : {};

let options = { merge: !!data.firebaseMerge };

if (data.addTimestamp) input.timestamp = getTimestampMillis();
if (data.customDataList) {
  data.customDataList.forEach((d) => {
    if (data.skipNilValues) {
      const dType = getType(d.value);
      if (dType === 'undefined' || dType === 'null') return;
    }
    if (getType(d.name) === 'string' && d.name.indexOf('.') !== -1) {
      const nameParts = d.name.split('.');
      let obj = input;
      for (let i = 0; i < nameParts.length - 1; i++) {
        const part = nameParts[i];
        if (!obj[part]) {
          obj[part] = {};
        }
        obj = obj[part];
      }
      obj[nameParts[nameParts.length - 1]] = d.value;
    } else {
      input[d.name] = d.value;
    }
  });
}

let path = buildPath(data.collection, data.documentId);

Firestore.write(path, input, options).then((id) => {
  if (isLoggingEnabled) {
    logToConsole(
      JSON.stringify({
        eventName: 'Firestore Write',
        documentId: id,
        data: input,
      })
    );
  }

  data.gtmOnSuccess();
}, data.gtmOnFailure);


function buildPath(collection, documentId) {  
  let path = collection;
  
  if (documentId) {
    path += '/' + documentId;
  }
  
  return path;
}

function determinateIsLoggingEnabled() {
  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_firestore",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedOptions",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  },
                  {
                    "type": 1,
                    "string": "databaseId"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "(default)"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 23/04/2022, 12:40:30

